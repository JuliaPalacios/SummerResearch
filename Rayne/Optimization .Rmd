---
title: "Re-Implementing Optimization "
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
library(ggplot2)
library(rootSolve)

#'Euclidean Norm between Two vectors 
#'
vec_norm <- function(x) {
  x <- as.vector(x)
  sqrt(sum(x^2))
}

inverse <- function(m) {
  solve(m, diag(dim(m)[1]))
}


cov_matrix <- function(X1, X2, kernel , c , l) {
  n <- dim(X1) [2]
  m <- dim(X2) [2]
  entries <- c()
  for (j in 1:n) {
    for (i in 1:m) {
      entries <- c(entries, kernel(X1[,i],X2[,j], c, l))
    }
  }
  matrix(entries, ncol = m) 
}

test_kernel <- function(x1, x2) {
  vec_norm(x1 - x2)
}

sqr_exp <- function(x1, x2, c = 1, l = 1) {
  r <- abs(x1 - x2)
  (c^2)*exp(-(r^2)/(2*(l^2)))
}

BM <- function(x, y, c = 0, l = 0) {
  min(x, y)
}

#' Covariance between two processes
#' @param y the output variables that we are trying to predict as a column vector 
GPReg <- function(X,y,kernel, noise, X_test, c, l) {
  covMat <- cov_matrix(cbind(X, X_test), cbind(X, X_test), kernel, c, l)
 
  n <- dim(X)[2]
  m <- dim(X_test)[2]
  KXX <- covMat[1:n,1:n]
  KXX_ <- covMat[1:n, (n+1):(n+m)]
  KX_X_ <- covMat[(n+1):(n+m), (n+1):(n+m)]
  
  L <- chol(KXX + noise*diag(n))
  L <- t(L)
  L_slash_y = solve(L,y)
  alpha = solve(t(L), L_slash_y)
  f_mean <- t(KXX_) %*% alpha
  v <- solve(L,KXX_)
  f_cov <- KX_X_ - (t(v) %*% v)
  loglike <- ((-0.5)*t(y) %*% alpha) - sum(diag(log(L))) - ((n/2)*log(2*pi))
  
  list(pred_mean = f_mean, pred_cov = f_cov, loglike = loglike)
}

logLike <- function(x,y, kernel, noise, c, l) {
   KXX <- cov_matrix(x, x, kernel, c, l) 
   n <- dim(x)[2] 
   
   L <- chol(KXX + noise*diag(n))
   L <- t(L)
   L_slash_y = solve(L,y)
   alpha = solve(t(L), L_slash_y)
   loglike <- ((-0.5)*t(y) %*% alpha) - sum(diag(log(L))) - ((n/2)*log(2*pi))
}

dk_dc <- function(x1, x2, c, l) {
  r <- vec_norm(x1 - x2)
  exp(-(r^2)/(2*(l^2))) 
}

dk_dl <- function(x1, x2, c, l) {
  r <- vec_norm(x1 - x2)
  ((c^2)*r^2*exp(-r^2/(2*(l^2))))/(2*l^4)
}

dKXX_dl <- function(x, c, l) {
  cov_matrix(x,x,dk_dl, c, l)
}

dKXX_dc <- function(x, c, l) { 
  cov_matrix(x,x,dk_dc, c, l) 
}

dlog_dc <- function(x, y, c, l) {
  K <- cov_matrix(x,x,sqr_exp, c, l)
  K_inv <- inverse(K)
  alpha <- K_inv %*% y
  m <- (alpha %*% t(alpha) - K_inv) %*% dKXX_dc(x,c,l)
  (0.5)*sum(diag(m))
}

dlog_dl <- function(x, y, c, l) {
  K <- cov_matrix(x,x,sqr_exp, c, l)
  K_inv <- inverse(K)
  alpha <- K_inv %*% y
  m <- (alpha %*% t(alpha) - K_inv) %*% dKXX_dl(x, c, l)
  (0.5)*sum(diag(m))
}

Fc <- function(c, l) {
  dlog_dc(x, y, c, l) 
}

Fl <- function(c,l) {
  dlog_dl(x, y, c, l)
}


model <- function(param) {
  c(F1 = Fc(param[1], param[2]), F2 = Fl(param[1], param[2])) 
}

optimize_params <- function(x, y, init) {
  ss <- multiroot(f = model, start = init) 
  c <- ss$root[1]
  l <- ss$root[2]
  list (c = c, l = l) 
}

plot_data <- function(res, x, y, x_test) {
  training <- data.frame(x = as.vector(x), y = as.vector(y)) 
  prediction <- data.frame(x = as.vector(x_test), y = as.vector(res$pred_mean)) 
  max <- res$pred_mean + 2*diag(res$pred_cov)
  min <- res$pred_mean - 2*diag(res$pred_cov)
  ribbon <- data.frame(x = as.vector(x_test), max = max, min = min)
  fun1 <- function(x) {fun} 
  ggplot(data = prediction, aes(x = prediction$x, y = prediction$y)) + geom_line(data = prediction , aes(x = prediction$x, y = prediction$y), color = "Red") + geom_point(data = training, aes(x = training$x, y = training$y)) + geom_ribbon(data = ribbon, aes(x = ribbon$x, ymax = as.vector(max), ymin = as.vector(min)), fill = "Pink", alpha = 0.5) + ylim(ymin = min(prediction$y, training$y), ymax = max(prediction$y, training$y))
}

```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file).
